<template>
    <v-dialog v-model="dialog" max-width="1500" min-height="300" max-height="650">

      <v-card prepend-icon="mdi-file" :title="repositorioVerificacao.id" >
        <v-card-text style="padding-top: 15px; padding-bottom: 5px;">
          <v-row dense>
            <v-col cols="12" md="12" sm="12">
                <v-textarea v-model="repositorioVerificacao.description" label="Verificação" variant="outlined" rows="3" resize></v-textarea>
            </v-col>

            <v-col cols="12" md="12" sm="12">
                <v-textarea v-model="repositorioVerificacao.instruction" label="Instrução" variant="outlined" rows="4" no-resize></v-textarea>
            </v-col>

            <!-- <v-col cols="6" md="6" sm="6">
                <v-select v-model="repositorioVerificacao.tipoVerificacao" label="Tipo de Verificação" :items="tiposDeVerificacao" variant="outlined"></v-select>
            </v-col> -->

            <v-col cols="12" md="12" sm="12" >
                <v-select 
                  multiple
                  v-model="repositorioVerificacao.tags"
                  label="Etiqueta(s)"
                  :items="etiquetas"
                  item-value="value"
                  item-title="label"
                  variant="outlined"
                  :error="!tagsValid"
                  :error-messages="tagsErrorMessage"                  
                  >
                </v-select>
            </v-col>
            
            <!-- 
            <v-col cols="12" md="12" sm="12">
                <v-textarea :model-value="repositorioVerificacao.obs" label="Observação" variant="outlined" rows="4" no-resize></v-textarea>
            </v-col> -->

          </v-row>

        </v-card-text>

        <v-divider></v-divider>

        <v-card-actions>
          <v-spacer></v-spacer>

            <div class="flex justify-between w-full">
              <div class="flex">
                <v-btn icon="mdi-undo" size="40" class="cursor-pointer" @click="handleClickReverterRule" v-if="hasOriginalRule"></v-btn>
              </div>
            
              <div class="flex justify-end">
                <v-btn text="FECHAR" variant="plain" @click="dialog = false"></v-btn>
                <v-btn text="SALVAR" color="primary" variant="tonal" @click="handleClickSalvarRule" :disabled="!isFormValid"></v-btn>
              </div>
            </div>
        </v-card-actions>
      </v-card>
    </v-dialog>

    <AppDialogConfirm ref="dialogRef"/>
</template>

<script setup lang="ts">
import { computed, inject, onMounted, ref } from 'vue'
import  { type RepositorioVerificacao } from '../../../interfaces/repositorio-verificacao';
import { repositorioVerificacaoService } from '../../../api/repositorioVerificacaoService';
import { ToastSymbol } from '../../../plugins/toast';
import AppDialogConfirm from '../../../components/ui/AppDialogConfirm.vue';

const toast = inject(ToastSymbol) as any
const dialogRef = ref()
const originalRule = ref<RepositorioVerificacao>()
const hasOriginalRule = ref(false);

const dialog = ref(false)
const repositorioVerificacao = ref<RepositorioVerificacao>()
const tiposDeVerificacao = ref(['Interna'])
const etiquetas = ref([
  { label: 'Titulo', value: 'title' },
  { label: 'Codigo', value: 'code' },
  { label: 'Capa', value: 'layer' },
  { label: 'Formato', value: 'format' },
  { label: 'Rev', value: 'rev' },
  { label: 'Ref. Doc', value: 'ref_doc' },
  { label: 'Gen Notes', value: 'gen_notes' },
  { label: 'Page Number', value: 'page_num' },
  { label: 'Legenda', value: 'legenda' },
  { label: 'Painel', value: 'panel' },
  { label: 'CDC', value: 'cdc' },
  { label: 'CCM', value: 'ccm' },
  { label: 'CF', value: 'cf' },
  // 'title', 'code', 'layer', 'format'
  // 'Titulo', 'Codigo', 'Capa', 'Formato', 'Rev', 'Painel', 'CDC', 'CCM', 'Emergência', 'CF'
])

// Computed que valida tudo
const isFormValid = computed(() => {
  const descOK = repositorioVerificacao.value.description?.trim().length >= 20;
  const instOK = repositorioVerificacao.value.instruction?.trim().length >= 20;
  const tagsOK = tagsValid.value;

  return descOK && instOK && tagsOK;
});

const tagsValid = computed(() => {
  return Array.isArray(repositorioVerificacao.value.tags) &&
                 repositorioVerificacao.value.tags.length >= 1 &&
                 repositorioVerificacao.value.tags.length <= 3;
});

const tagsErrorMessage = computed(() => {
  return tagsValid.value
    ? ""
    : "Escolhe entre 1 a 3 tags.";
});

async function open(repo: RepositorioVerificacao) {
  console.log(repositorioVerificacao)
  repositorioVerificacao.value = repo;
  const resultOriginalRule = await repositorioVerificacaoService.getOriginalRuleById(repositorioVerificacao.value.id.toString());
  originalRule.value = resultOriginalRule.model;

  hasOriginalRule.value = originalRule != null ? true : false;

  dialog.value = true
}

defineExpose({ open })
const emit = defineEmits(["updated"])

onMounted(async () => {
  console.log('Componente montado')
})

async function handleClickSalvarRule() {  
  atualizaVerificacao(repositorioVerificacao.value);
}

async function atualizaVerificacao(objectVerificacao: RepositorioVerificacao, showToast: boolean = true) {
  try {
    const resultUpdateRule = await repositorioVerificacaoService.update(repositorioVerificacao.value.id.toString(), objectVerificacao)

    if (!resultUpdateRule.success) {
      toast.warning(resultUpdateRule.message ?? "Não foi possível atualizar verificação!");
    }

    if (showToast) { toast.success(`Verificação ${objectVerificacao.id} atualizada com sucesso!`);}
    emit("updated", objectVerificacao);
    dialog.value = false
  } catch (error) {
    dialog.value = true;
    toast.warning(`Não foi possível modificar a verificação ${objectVerificacao.id}.`)
  }  
}

async function handleClickReverterRule() {
  try {
    
    const dialogResult = await dialogRef.value.open('Reverter verificação para original', 'Tem certeza que deseja continuar?', 2);

    if (dialogResult) {
      atualizaVerificacao(originalRule.value, false)
      toast.success(`Verificação ${originalRule.value.id} revertida com sucesso!`);
      emit("updated", originalRule.value);
      dialog.value = false;
    }

  } catch (error) {
    toast.warning("Não foi possível reverter verificação.");
    dialog.value = true;
  }
}

</script>

<style>

.v-card-item {
    background-color: var(--primary-brand);
    color: white;
}

</style>
