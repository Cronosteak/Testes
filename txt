INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [3776015]
INFO:numexpr.utils:Note: NumExpr detected 52 cores but "NUMEXPR_MAX_THREADS" not set, so enforcing safe limit of 16.
INFO:numexpr.utils:NumExpr defaulting to 16 threads.
INFO:     Started server process [3780053]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8001 (Press CTRL+C to quit)
INFO:api_fisc_internal:Received pipeline trigger for job: 4c7a21e5-585f-495b-98a8-d86530e2ab41
INFO:     10.30.121.55:53556 - "POST /pipeline/run HTTP/1.1" 200 OK
INFO:pipeline_worker:Starting pipeline for Job ID: 4c7a21e5-585f-495b-98a8-d86530e2ab41
INFO:pipeline_worker:[pipeline] Running script: convert_documents.py
ERROR:pipeline_worker:[pipeline] Script convert_documents.py FAILED code 1
ERROR:pipeline_worker:[convert_documents.py] stderr:
Traceback (most recent call last):
  File "/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/scripts/convert_documents.py", line 27, in <module>
    from src.conversion import (
  File "/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/src/conversion/__init__.py", line 8, in <module>
    from .converters import (
ImportError: cannot import name 'PyMuPDF4LLMExporter' from 'src.conversion.converters' (/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/src/conversion/converters.py)

ERROR:pipeline_worker:Pipeline failed for 4c7a21e5-585f-495b-98a8-d86530e2ab41
Traceback (most recent call last):
  File "/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/app/pipeline.py", line 78, in run_full_pipeline
    run_script("convert_documents.py", raw_dir, processed_dir)
  File "/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/app/pipeline.py", line 32, in run_script
    result = subprocess.run(
  File "/usr/lib/python3.10/subprocess.py", line 526, in run
    raise CalledProcessError(retcode, process.args,
subprocess.CalledProcessError: Command '['/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/venv/bin/python', '/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/scripts/convert_documents.py', '--input', '/nethome/prosei_d/Prosei/shared_data/jobs/4c7a21e5-585f-495b-98a8-d86530e2ab41/raw', '--output', '/nethome/prosei_d/Prosei/shared_data/jobs/4c7a21e5-585f-495b-98a8-d86530e2ab41/processed']' returned non-zero exit status 1.
INFO:api_fisc_internal:Received pipeline trigger for job: ad3ca3c4-a5fb-4456-b759-4a7c10d9af2b
INFO:     10.30.121.55:35754 - "POST /pipeline/run HTTP/1.1" 200 OK
INFO:pipeline_worker:Starting pipeline for Job ID: ad3ca3c4-a5fb-4456-b759-4a7c10d9af2b
INFO:pipeline_worker:[pipeline] Running script: convert_documents.py
INFO:pipeline_worker:[convert_documents.py] stdout:
2026-02-04 16:00:46,776 - Prosei-test - INFO - (logging_config.py:49) - Logger setup complete.
2026-02-04 16:00:46,776 - Prosei-test - INFO - (convert_documents.py:140) - --- Document Conversion Script Started ---
2026-02-04 16:00:46,779 - Prosei-test - INFO - (convert_documents.py:51) - Loading configuration from: /nethome/prosei_d/Prosei/prosei-api-fiscalizacion/configs/convert_config.json
2026-02-04 16:00:46,781 - Prosei-test - INFO - (convert_documents.py:71) - Instantiating converter: DoclingJsonTablesExporter with parameters: {'do_ocr': True, 'do_table_structure': True, 'do_cell_matching': True}
2026-02-04 16:00:46,792 - Prosei-test - INFO - (convert_documents.py:167) - Input directory set to: /nethome/prosei_d/Prosei/shared_data/jobs/ad3ca3c4-a5fb-4456-b759-4a7c10d9af2b/raw
2026-02-04 16:00:46,793 - Prosei-test - INFO - (convert_documents.py:168) - Output directory set to: /nethome/prosei_d/Prosei/shared_data/jobs/ad3ca3c4-a5fb-4456-b759-4a7c10d9af2b/processed
2026-02-04 16:00:46,797 - Prosei-test - INFO - (convert_documents.py:95) - Found 1 PDF(s) to process.
2026-02-04 16:00:46,798 - Prosei-test - INFO - (converters.py:105) - Starting Docling JSON+tables conversion for: /nethome/prosei_d/Prosei/shared_data/jobs/ad3ca3c4-a5fb-4456-b759-4a7c10d9af2b/raw/input.pdf
2026-02-04 16:01:32,826 - Prosei-test - ERROR - (converters.py:110) - Failed to convert /nethome/prosei_d/Prosei/shared_data/jobs/ad3ca3c4-a5fb-4456-b759-4a7c10d9af2b/raw/input.pdf with Docling: libgthread-2.0.so.0: cannot open shared object file: No such file or directory
Traceback (most recent call last):
  File "/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/src/conversion/converters.py", line 108, in convert_and_save
    result = self._convert_with_docling(source_path, page_range=page_range)
  File "/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/src/conversion/converters.py", line 76, in _convert_with_docling
    return self.doc_converter.convert(str(source_path))
  File "/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/venv/lib/python3.10/site-packages/pydantic/_internal/_validate_call.py", line 39, in wrapper_function
    return wrapper(*args, **kwargs)
  File "/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/venv/lib/python3.10/site-packages/pydantic/_internal/_validate_call.py", line 136, in __call__
    res = self.__pydantic_validator__.validate_python(pydantic_core.ArgsKwargs(args, kwargs))
  File "/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/venv/lib/python3.10/site-packages/docling/document_converter.py", line 325, in convert
    return next(all_res)
  File "/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/venv/lib/python3.10/site-packages/docling/document_converter.py", line 368, in convert_all
    for conv_res in conv_res_iter:
  File "/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/venv/lib/python3.10/site-packages/docling/document_converter.py", line 467, in _convert
    for item in map(
  File "/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/venv/lib/python3.10/site-packages/docling/document_converter.py", line 514, in _process_document
    conv_res = self._execute_pipeline(in_doc, raises_on_error=raises_on_error)
  File "/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/venv/lib/python3.10/site-packages/docling/document_converter.py", line 535, in _execute_pipeline
    pipeline = self._get_pipeline(in_doc.format)
  File "/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/venv/lib/python3.10/site-packages/docling/document_converter.py", line 497, in _get_pipeline
    self.initialized_pipelines[cache_key] = pipeline_class(
  File "/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/venv/lib/python3.10/site-packages/docling/pipeline/standard_pdf_pipeline.py", line 438, in __init__
    self._init_models()
  File "/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/venv/lib/python3.10/site-packages/docling/pipeline/standard_pdf_pipeline.py", line 468, in _init_models
    self.table_model = table_factory.create_instance(
  File "/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/venv/lib/python3.10/site-packages/docling/models/factories/base_factory.py", line 57, in create_instance
    return _cls(options=options, **kwargs)
  File "/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/venv/lib/python3.10/site-packages/docling/models/stages/table_structure/table_structure_model.py", line 72, in __init__
    from docling_ibm_models.tableformer.data_management.tf_predictor import (
  File "/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/venv/lib/python3.10/site-packages/docling_ibm_models/tableformer/data_management/tf_predictor.py", line 13, in <module>
    import cv2
ImportError: libgthread-2.0.so.0: cannot open shared object file: No such file or directory
2026-02-04 16:01:32,842 - Prosei-test - WARNING - (convert_documents.py:113) - Conversion failed or produced empty file for: input.pdf
2026-02-04 16:01:32,843 - Prosei-test - INFO - (convert_documents.py:119) - --- Processing Summary ---
2026-02-04 16:01:32,844 - Prosei-test - INFO - (convert_documents.py:120) - Successfully converted: 0
2026-02-04 16:01:32,844 - Prosei-test - INFO - (convert_documents.py:121) - Failed to convert:    1
2026-02-04 16:01:32,845 - Prosei-test - INFO - (convert_documents.py:122) - Total files:           1
2026-02-04 16:01:32,845 - Prosei-test - INFO - (converters.py:189) - No tables were collected; skipping tables_index.json
2026-02-04 16:01:32,846 - Prosei-test - INFO - (convert_documents.py:171) - --- Document Conversion Script Finished ---

WARNING:pipeline_worker:[convert_documents.py] stderr:
/nethome/prosei_d/Prosei/prosei-api-fiscalizacion/venv/lib/python3.10/site-packages/pydantic/main.py:464: UserWarning: Pydantic serializer warnings:
  PydanticSerializationUnexpectedValue(Expected `list[str]` - serialized value may not be as expected [field_name='lang', input_value=('pt', 'en'), input_type=tuple])
  return self.__pydantic_serializer__.to_python(
No OCR engine found. Please review the install details.
-> Cannot close object, library is destroyed. This may cause a memory leak!

INFO:pipeline_worker:[pipeline] Stage 'conversion' finished in 58.39 seconds
INFO:pipeline_worker:[pipeline] Running script: preprocess_texts.py
INFO:pipeline_worker:[preprocess_texts.py] stdout:
2026-02-04 16:01:33,965 - Prosei-test - INFO - (logging_config.py:49) - Logger setup complete.
2026-02-04 16:01:33,965 - Prosei-test - INFO - (preprocess_texts.py:88) - --- Text Preprocessing Script Started ---
2026-02-04 16:01:33,968 - Prosei-test - INFO - (preprocess_texts.py:40) - Loading configuration from: /nethome/prosei_d/Prosei/prosei-api-fiscalizacion/configs/preprocess_config.json
2026-02-04 16:01:33,970 - Prosei-test - INFO - (preprocess_texts.py:114) - Input directory: /nethome/prosei_d/Prosei/shared_data/jobs/ad3ca3c4-a5fb-4456-b759-4a7c10d9af2b/processed
2026-02-04 16:01:33,971 - Prosei-test - INFO - (preprocess_texts.py:115) - Output directory: /nethome/prosei_d/Prosei/shared_data/jobs/ad3ca3c4-a5fb-4456-b759-4a7c10d9af2b/cleaned
2026-02-04 16:01:33,972 - Prosei-test - INFO - (preprocess_texts.py:116) - Enabled steps: ['remove_excessive_line_breaks', 'to_lowercase']
2026-02-04 16:01:33,976 - Prosei-test - WARNING - (preprocess_texts.py:58) - No Markdown files found in /nethome/prosei_d/Prosei/shared_data/jobs/ad3ca3c4-a5fb-4456-b759-4a7c10d9af2b/processed
2026-02-04 16:01:33,976 - Prosei-test - INFO - (preprocess_texts.py:120) - --- Text Preprocessing Script Finished ---

INFO:pipeline_worker:[pipeline] Stage 'preprocessing' finished in 0.09 seconds
INFO:pipeline_worker:[pipeline] Running script: segment_documents.py
INFO:pipeline_worker:[segment_documents.py] stdout:
2026-02-04 16:01:35,067 - Prosei-test - INFO - (logging_config.py:49) - Logger setup complete.
2026-02-04 16:01:35,067 - Prosei-test - INFO - (segment_documents.py:177) - --- Document Segmentation Script Started ---
2026-02-04 16:01:35,069 - Prosei-test - INFO - (segment_documents.py:56) - Loading configuration from: /nethome/prosei_d/Prosei/prosei-api-fiscalizacion/configs/segment_config.json
2026-02-04 16:01:35,071 - Prosei-test - INFO - (segment_documents.py:102) - Instantiating splitter: rules
2026-02-04 16:01:35,072 - Prosei-test - INFO - (segment_documents.py:206) - Input directory: /nethome/prosei_d/Prosei/shared_data/jobs/ad3ca3c4-a5fb-4456-b759-4a7c10d9af2b/cleaned
2026-02-04 16:01:35,072 - Prosei-test - INFO - (segment_documents.py:207) - Output directory: /nethome/prosei_d/Prosei/shared_data/jobs/ad3ca3c4-a5fb-4456-b759-4a7c10d9af2b/segmented
2026-02-04 16:01:35,075 - Prosei-test - WARNING - (segment_documents.py:128) - No Markdown files found in /nethome/prosei_d/Prosei/shared_data/jobs/ad3ca3c4-a5fb-4456-b759-4a7c10d9af2b/cleaned
2026-02-04 16:01:35,076 - Prosei-test - INFO - (segment_documents.py:212) - --- Document Segmentation Script Finished ---

INFO:pipeline_worker:[pipeline] Stage 'segmenting' finished in 1.15 seconds
INFO:pipeline_worker:[pipeline] Running script: tag_blocks.py
INFO:pipeline_worker:[tag_blocks.py] stdout:
2026-02-04 16:01:36,023 - Prosei-test - INFO - (logging_config.py:49) - Logger setup complete.
2026-02-04 16:01:36,023 - Prosei-test - INFO - (tag_blocks.py:143) - --- Document Tagging Script Started ---
2026-02-04 16:01:36,025 - Prosei-test - INFO - (tag_blocks.py:49) - Loading Azure credentials for BlockTagger...
2026-02-04 16:01:36,025 - Prosei-test - INFO - (tag_blocks.py:64) - Instantiating BlockTagger for endpoint: https://apit.petrobras.com.br/ia/openai/v1/openai-azure
2026-02-04 16:01:36,151 - Prosei-test - INFO - (tag_blocks.py:164) - Input directory: /nethome/prosei_d/Prosei/shared_data/jobs/ad3ca3c4-a5fb-4456-b759-4a7c10d9af2b/segmented
2026-02-04 16:01:36,152 - Prosei-test - INFO - (tag_blocks.py:165) - Output directory: /nethome/prosei_d/Prosei/shared_data/jobs/ad3ca3c4-a5fb-4456-b759-4a7c10d9af2b/tagged
2026-02-04 16:01:36,157 - Prosei-test - WARNING - (tag_blocks.py:87) - No segmented JSON files found in /nethome/prosei_d/Prosei/shared_data/jobs/ad3ca3c4-a5fb-4456-b759-4a7c10d9af2b/segmented
2026-02-04 16:01:36,157 - Prosei-test - INFO - (tag_blocks.py:170) - --- Document Tagging Script Finished ---

INFO:pipeline_worker:[pipeline] Stage 'tagging' finished in 1.08 seconds
INFO:pipeline_worker:[pipeline] Running script: verify_documents.py
INFO:pipeline_worker:[verify_documents.py] stdout:
2026-02-04 16:01:37,272 - Prosei-test - INFO - (logging_config.py:49) - Logger setup complete.
2026-02-04 16:01:37,273 - Prosei-test - INFO - (verify_documents.py:223) - --- Document Verification Script Started ---
2026-02-04 16:01:37,275 - Prosei-test - INFO - (verify_documents.py:42) - Loading configuration from: /nethome/prosei_d/Prosei/prosei-api-fiscalizacion/configs/verify_config.json
2026-02-04 16:01:37,277 - Prosei-test - INFO - (verification_loader.py:30) - Loading verification rules from: /nethome/prosei_d/Prosei/prosei-api-fiscalizacion/configs/rules_lista_cargas.json
2026-02-04 16:01:37,279 - Prosei-test - INFO - (verification_loader.py:44) - Successfully loaded 25 rules for 'Lista de Cargas'.
2026-02-04 16:01:37,280 - Prosei-test - INFO - (verify_documents.py:49) - Loading Azure credentials for DocumentVerifier...
2026-02-04 16:01:37,281 - Prosei-test - INFO - (verify_documents.py:64) - Instantiating DocumentVerifier for endpoint: https://apit.petrobras.com.br/ia/openai/v1/openai-azure
2026-02-04 16:01:37,331 - Prosei-test - INFO - (verify_documents.py:253) - Input directory: /nethome/prosei_d/Prosei/shared_data/jobs/ad3ca3c4-a5fb-4456-b759-4a7c10d9af2b/tagged
2026-02-04 16:01:37,332 - Prosei-test - INFO - (verify_documents.py:254) - Output directory: /nethome/prosei_d/Prosei/shared_data/jobs/ad3ca3c4-a5fb-4456-b759-4a7c10d9af2b/verification_reports
2026-02-04 16:01:37,333 - Prosei-test - INFO - (verify_documents.py:255) - Document type: lista_cargas (25 rules loaded)
2026-02-04 16:01:37,337 - Prosei-test - WARNING - (verify_documents.py:190) - No tagged JSON files found in /nethome/prosei_d/Prosei/shared_data/jobs/ad3ca3c4-a5fb-4456-b759-4a7c10d9af2b/tagged
2026-02-04 16:01:37,337 - Prosei-test - INFO - (verify_documents.py:259) - --- Document Verification Script Finished ---

INFO:pipeline_worker:[pipeline] Stage 'verifying' finished in 1.19 seconds
INFO:pipeline_worker:Pipeline finished successfully for ad3ca3c4-a5fb-4456-b759-4a7c10d9af2b in 61.94 seconds
