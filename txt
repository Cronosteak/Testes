<template>
  <v-app>
    <Navbar v-model:drawer="drawer"/>
    <v-layout>
      <Sidebar 
        v-model="drawer"
        :is-desktop="isDesktop"
        :opcoes-menu-fiscalizacao="opcoesMenuFiscalizacao"
        :opcoes-menu-automacao="opcoesMenuAutomacao"
        />
      <MainContent />
      <ChatBot />
    </v-layout>
  </v-app>
</template>

<script setup lang="ts">
import { ref, onMounted, onBeforeUnmount, computed } from 'vue'
import Sidebar from '../components/layout/Sidebar.vue'
import MainContent from '../components/layout/MainContent.vue'
import Navbar from '../components/layout/Navbar.vue'
import ChatBot from '../components/ui/ChatBot.vue'
import { getIsOpenMenu } from '../utils/util'
import { useJobPollingStore } from '../stores/jobPolling'
import { storeToRefs } from 'pinia'
import { watch } from 'vue'

const jobPolling = useJobPollingStore();
const { relatorioFinalizado, isGerandoAnalise, isPollingActive, isFailed } = storeToRefs(jobPolling);

const appendIcon = ref('');

watch([isGerandoAnalise, relatorioFinalizado], () => {
  if (isGerandoAnalise.value || isPollingActive.value) {
    appendIcon.value = "mdi-loading mdi-spin";
    return;
  } else if (relatorioFinalizado.value && isFailed.value) {
    appendIcon.value = "mdi-close-circle-outline";
    return;
  } else if (relatorioFinalizado.value && !isFailed.value) {
    appendIcon.value = "mdi-check-circle-outline";
    return;    
  }

  appendIcon.value = "";
}, { immediate: true });

const opcoesMenuFiscalizacao = computed(() => [
  ['Dashboard', 'mdi-account-multiple-outline', { name: 'dashboard' }],
  ['Verificação de Documentos', 'mdi-account-multiple-outline', { name: 'verificacao-projeto' }, appendIcon.value],
  ['Repositório de Verificações', 'mdi-cog-outline', {name: 'repositorio-verificacao'}],
  ['Histórico', 'mdi-cog-outline', {name: 'historico-atividade'}],
  ['Assistente Virtual', 'mdi-cog-outline', {name: 'chatbot'}],
  // ['Configurações', 'mdi-cog-outline', {name: 'configuracoes'}],
])

const opcoesMenuAutomacao: any = [
  // ['Banco de Dados', 'mdi-account-multiple-outline', {name: 'banco-de-dados'}],
  ['Lista de Cargas Elétricas', 'mdi-account-multiple-outline', {name: 'lista-cargas'}],
  // ['LC => CCM', 'mdi-account-multiple-outline', {name: 'lc-para-ccm'}],
  // ['Teste1', 'mdi-cog-outline', {name: 'lista-equipamentos'}],
  // ['Teste2', 'mdi-cog-outline', {name: 'lista-equipamentos'}],
]

const drawer = ref(getIsOpenMenu()) // update visual navbar
// const drawer = ref(window.innerWidth >= 960) // menu aberto no desktop
const isDesktop = ref(window.innerWidth >= 960)

function handleResize() {
  isDesktop.value = window.innerWidth >= 960

  if (!isDesktop.value) {
    localStorage.setItem('isOpenMenu', '0')
    drawer.value = false
  }
  // else drawer.value = true
}

onMounted(() => window.addEventListener('resize', handleResize))
onBeforeUnmount(() => window.removeEventListener('resize', handleResize))

</script>


<style lang="scss">

.v-list-item-title {
    font-size: .8125rem !important;
    font-weight: 500 !important;
    letter-spacing: normal !important;
    line-height: 1rem !important;
}

</style>
